services:
    postgres:
        image: postgres:15-alpine
        container_name: medilab-postgres
        environment:
            POSTGRES_DB: medilab_db
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: password
        volumes:
            - postgres-data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        networks:
            - medilab-network
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U postgres" ]
            interval: 5s
            timeout: 5s
            retries: 5

    backend:
        build:
            context: .
            dockerfile: Dockerfile.dev
        environment:
            - GOOGLE_API_KEY=${GOOGLE_API_KEY:-placeholder}
            - DB_URL=jdbc:postgresql://postgres:5432/medilab_db
            - DB_USERNAME=postgres
            - DB_PASSWORD=password
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
            - RABBITMQ_USERNAME=guest
            - RABBITMQ_PASSWORD=guest
            - LIQUIBASE_DUPLICATE_FILE_MODE=WARN
            - MINIO_ENDPOINT=http://minio:9000
            - MINIO_ACCESS_KEY=minioadmin
            - MINIO_SECRET_KEY=minioadmin
            - MINIO_BUCKET_NAME=medilab-reports
            - MINIO_PUBLIC_ENDPOINT=${PUBLIC_URL:-http://localhost}
        volumes:
            - ./src:/app/src
            - ./pom.xml:/app/pom.xml
        depends_on:
            postgres:
                condition: service_healthy
            rabbitmq:
                condition: service_started
            minio:
                condition: service_started
        networks:
            - medilab-network

    notification:
        build:
            context: ./services/notification-service
            dockerfile: Dockerfile.dev
        environment:
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
            - RABBITMQ_USERNAME=guest
            - RABBITMQ_PASSWORD=guest
            - MAIL_HOST=smtp.gmail.com
            - MAIL_PORT=587
            - MAIL_USERNAME=ko.mail.sender@gmail.com
            - MAIL_PASSWORD=wscidfgsuzgtmmuo
        volumes:
            - ./services/notification-service/src:/app/src
            - ./services/notification-service/pom.xml:/app/pom.xml
        depends_on:
            - rabbitmq
        networks:
            - medilab-network

    frontend:
        build:
            context: ../medilab-pro-frontend
        ports:
            - "3000:3000"
        depends_on:
            - backend
        networks:
            - medilab-network

    rabbitmq:
        image: rabbitmq:3-management-alpine
        container_name: medilab-rabbitmq
        networks:
            - medilab-network

    minio:
        image: minio/minio:latest
        container_name: medilab-minio
        environment:
            - MINIO_ROOT_USER=minioadmin
            - MINIO_ROOT_PASSWORD=minioadmin
        volumes:
            - minio-data:/data
        command: server /data --console-address ":9001"
        networks:
            - medilab-network

networks:
    medilab-network:
        driver: bridge

volumes:
    postgres-data:
    minio-data:
